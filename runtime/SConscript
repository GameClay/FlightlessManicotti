Import('env')
runtime_env = env.Clone()

#runtime_env.Replace(CC = "clang")

# Files used for runtime library
core_files = Glob('core/*.c', strings=True)
c1x_files = Glob('std/C1x/*.c', strings=True)
script_files = Glob('script/*.c', strings=True) + Glob('script/modules/*.c', strings=True)

# Autogenerated Lua wrappers
import build_swig_header
runtime_env.Append(SWIGFLAGS=['-lua'])
swig_files = Glob('script/swig/*.i', strings=True)
runtime_env.Command("swig_autogen.h", swig_files, build_swig_header.build)

# Assemble the runtime lib source files
lib_files = core_files + c1x_files + script_files + swig_files

# Prune out excluded files
excluded_files = []
lib_files = [f for f in lib_files if f not in excluded_files]

# Dependencies of the runtime lib
lib_src_dir = 'lib/'
    
runtime_lib_includes = [
   lib_src_dir + 'amp/src/c',
   lib_src_dir + 'lua/src',
   lib_src_dir + 'nedmalloc',
   lib_src_dir + 'MicroAllocator'
]

runtime_lib_paths = [
   lib_src_dir + 'lua/.build',
   lib_src_dir + 'amp/.build',
   lib_src_dir + 'MicroAllocator/.build',
   lib_src_dir + 'nedmalloc/x86/Release'
]

# Build runtime library
runtime_env.Append(CPPDEFINES=['KL_BUILD_LIBRARY'])
runtime_lib = runtime_env.SharedLibrary('FlightlessManicotti', 
	lib_files,
	CPPPATH = ['.'] + runtime_lib_includes,
 	CCFLAGS = ['-g','-std=c99'] + env['CCFLAGS'],
	LIBS=['amp','lua','nedmalloc','MicroAllocator','libstdc++'], 
	LIBPATH=['.'] + runtime_lib_paths
)

# Find the headers
# sources, headers = env.FindAllSourceFiles(runtime_lib)

Return('runtime_lib')